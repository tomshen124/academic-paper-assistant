# 学术论文辅助平台数据存储架构文档

## 1. 概述

本文档描述了学术论文辅助平台的数据存储架构，包括数据库存储、缓存存储和内存存储的使用情况。该平台采用多层次的数据存储策略，确保数据的持久性、一致性和高效访问。

## 2. 数据存储架构

### 2.1 数据库存储 (PostgreSQL)

PostgreSQL 数据库作为系统的主要持久化存储层，存储所有需要长期保存的用户数据和应用状态。

#### 主要数据模型

| 数据模型 | 描述 | 关键字段 | 关联关系 |
|---------|------|---------|---------|
| **User** | 用户信息和认证数据 | id, email, username, hashed_password, is_active, is_superuser | 与 Topic, Outline, Paper, TokenUsage 建立一对多关系 |
| **Topic** | 论文主题信息和分析结果 | id, user_id, title, research_question, academic_field, feasibility, innovation | 与 User 建立多对一关系，与 Outline 建立一对多关系 |
| **Outline** | 论文提纲结构 | id, user_id, topic_id, title, abstract, keywords, sections | 与 User, Topic 建立多对一关系，与 Paper 建立一对多关系 |
| **Paper** | 论文内容 | id, user_id, outline_id, title, content, status | 与 User, Outline 建立多对一关系，与 Citation 建立一对多关系 |
| **Citation** | 论文引用信息 | id, paper_id, title, authors, publication, year, url | 与 Paper 建立多对一关系 |
| **TokenUsage** | Token 使用记录 | id, user_id, model, service, task, prompt_tokens, completion_tokens, total_tokens, estimated_cost, timestamp | 与 User 建立多对一关系 |

#### 数据库存储特点

- **完全持久化**：所有用户数据和应用状态都存储在数据库中，确保数据不会因服务重启而丢失
- **关系完整性**：通过外键约束确保数据的关系完整性
- **事务支持**：支持 ACID 事务，确保数据操作的原子性、一致性、隔离性和持久性
- **查询优化**：通过索引和优化的查询语句提高数据访问效率

### 2.2 缓存存储 (Redis)

Redis 作为系统的缓存层，用于存储临时数据和频繁访问的数据，提高系统性能。

#### 主要缓存类型

| 缓存类型 | 描述 | 过期时间 | 使用场景 |
|---------|------|---------|---------|
| **统计数据缓存** | 缓存统计结果，如实体类型分布、关系类型分布等 | 1 小时 | 减少重复计算，提高统计查询性能 |
| **LLM 响应缓存** | 缓存 LLM 的响应，避免重复请求 | 可配置 (默认 1 小时) | 减少 LLM API 调用，降低成本和延迟 |
| **会话状态** | 存储临时的会话状态和上下文信息 | 会话期间 | 维护用户会话状态，支持多步骤交互 |

#### 缓存存储特点

- **高性能**：内存存储提供毫秒级的访问速度
- **过期机制**：自动过期机制确保缓存数据的新鲜度
- **数据结构**：支持多种数据结构，如字符串、哈希、列表等
- **原子操作**：支持原子操作，避免并发问题

### 2.3 内存存储

系统中的一些服务使用内存存储临时数据，这些数据通常不需要持久化或已经有对应的数据库存储。

#### 主要内存存储

| 服务 | 存储内容 | 用途 | 持久化策略 |
|------|---------|------|-----------|
| **智能体服务 (AgentService)** | 智能体实例和记忆 | 维护智能体状态和上下文 | 记忆限制为 10 条消息，不需要持久化 |
| **LLM 服务 (LLMService)** | 可用模型列表和回退模型配置 | 支持 LLM 调用和回退策略 | 从配置文件加载，不需要持久化 |
| **学术搜索服务 (AcademicSearchService)** | 搜索源配置和缓存的搜索结果 | 提供学术搜索功能 | 搜索结果是临时的，不需要持久化 |

#### 内存存储特点

- **高效访问**：直接内存访问，提供最快的数据访问速度
- **临时性**：服务重启后数据会丢失，适合存储临时数据
- **低延迟**：适合存储频繁访问的小型数据

### 2.4 文件系统存储

系统使用文件系统存储一些配置和缓存数据。

#### 主要文件系统存储

| 存储类型 | 路径 | 用途 | 管理策略 |
|---------|------|------|---------|
| **LiteLLM 缓存** | `.cache/litellm` | 缓存 LLM 的响应 | 自动管理，定期清理 |
| **配置文件** | `config` 目录 | 存储系统配置 | 手动管理，版本控制 |
| **日志文件** | `logs` 目录 | 存储系统日志 | 自动轮转，定期归档 |

## 3. 数据流转

### 3.1 用户数据流

1. **用户创建主题**：
   - 用户输入 → API 接口 → TopicService → 数据库存储
   - LLM 调用记录 → TokenService → 数据库存储 (TokenUsage 表)

2. **生成提纲**：
   - 主题数据 → 数据库读取 → OutlineService → LLM 调用 → 提纲生成
   - 提纲数据 → 数据库存储 (Outline 表)
   - LLM 调用记录 → TokenService → 数据库存储 (TokenUsage 表)

3. **生成论文**：
   - 提纲数据 → 数据库读取 → PaperService → LLM 调用 → 论文生成
   - 论文数据 → 数据库存储 (Paper 表)
   - 引用数据 → 数据库存储 (Citation 表)
   - LLM 调用记录 → TokenService → 数据库存储 (TokenUsage 表)

### 3.2 缓存数据流

1. **统计数据缓存**：
   - 首次请求 → 数据库查询 → 结果缓存到 Redis → 返回结果
   - 后续请求 → Redis 缓存读取 → 返回结果
   - 缓存过期 → 重新查询数据库 → 更新缓存

2. **LLM 响应缓存**：
   - 首次请求 → LLM API 调用 → 结果缓存 → 返回结果
   - 相同请求 → 缓存读取 → 返回结果
   - 缓存过期 → 重新调用 LLM API → 更新缓存

## 4. 数据一致性保障

### 4.1 数据库一致性

- **事务管理**：使用 SQLAlchemy 的事务管理确保数据操作的原子性
- **异常处理**：在数据库操作中使用 try-except-finally 模式，确保资源正确释放
- **连接池管理**：使用连接池管理数据库连接，避免连接泄漏

### 4.2 缓存一致性

- **过期策略**：设置合理的缓存过期时间，确保数据最终一致性
- **主动失效**：在数据更新时主动使相关缓存失效
- **缓存键设计**：使用包含版本或时间戳的缓存键，支持缓存版本控制

## 5. 当前状态

目前，系统的数据存储架构已经完成了从内存存储到数据库存储的迁移，所有关键用户数据和应用状态都已经使用数据库持久化存储。

### 5.1 已完成的迁移

- **Token 使用统计**：已完全迁移到数据库存储，不再使用内存存储
- **用户数据**：所有用户相关数据（主题、提纲、论文、引用）都使用数据库存储
- **统计数据**：统计结果使用 Redis 缓存，但原始数据存储在数据库中

### 5.2 仍使用内存的部分

- **智能体记忆**：智能体的短期记忆仍存储在内存中，限制为 10 条消息
- **配置信息**：一些运行时配置信息存储在内存中，从配置文件加载
- **会话状态**：当前会话的临时状态存储在内存或 Redis 中

## 6. 未来改进计划

### 6.1 潜在改进点

1. **智能体记忆持久化**：
   - 将智能体的记忆持久化到数据库，支持长期记忆和跨会话的上下文理解
   - 实现记忆的分级存储（短期记忆在内存，长期记忆在数据库）

2. **配置管理优化**：
   - 将更多的配置信息移到数据库中，支持动态配置和在线更新
   - 实现配置版本控制和回滚机制

3. **缓存策略优化**：
   - 实现更智能的缓存预热和失效策略
   - 根据访问模式动态调整缓存过期时间

4. **数据分析和监控**：
   - 实现数据使用情况的监控和分析
   - 根据数据访问模式优化存储策略

## 7. 结论

学术论文辅助平台采用了多层次的数据存储架构，包括 PostgreSQL 数据库作为持久化存储层，Redis 作为缓存层，以及内存存储用于临时数据。这种架构确保了数据的持久性、一致性和高效访问。

目前，所有关键用户数据和应用状态都已经使用数据库持久化存储，只有临时数据和缓存数据使用内存或 Redis 存储。未来的改进将集中在智能体记忆持久化、配置管理优化和缓存策略优化等方面。
